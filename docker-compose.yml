# ABOUTME: Docker Compose configuration for gorp Matrix-Claude bridge
# ABOUTME: Uses XDG-compliant paths with volume mounts for config and data persistence
version: '3.8'

services:
  # Labs workspace - provides terminal and browser access to workspace files
  labs:
    build:
      context: https://github.com/2389-research/labs.git
      dockerfile: docker/Dockerfile.workspace
    image: labs-workspace:latest
    container_name: gorp-labs
    restart: unless-stopped
    environment:
      - TZ=America/Chicago
    volumes:
      # Same workspace as gorp - user can browse/edit Claude's files
      - ./app-data/workspace:/home/user/workspace
    ports:
      # Terminal (ttyd)
      - "7681:7681"
      # Browser (noVNC)
      - "6080:6080"
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"

  gorp:
    build: .
    image: gorp:latest
    container_name: gorp
    restart: unless-stopped

    # Environment variables (override config.toml values)
    # Use env_file OR environment, not both for the same vars
    env_file:
      - .env

    # Required for Docker: bind to all interfaces so port forwarding works
    environment:
      - WEBHOOK_BIND_ADDRESS=0.0.0.0
      - TZ=America/Chicago

    # Persistent volumes - all data under ./app-data/
    volumes:
      # Config directory - put your config.toml here
      - ./app-data/config:/home/gorp/.config/gorp

      # Claude Code config - persists auth across restarts
      - ./app-data/claude-config:/home/gorp/.config/claude

      # Claude CLI settings (API key, preferences)
      - ./app-data/claude-settings:/home/gorp/.claude

      # Data directory (crypto store, logs, scheduled prompts db)
      - ./app-data/data:/home/gorp/.local/share/gorp

      # Workspace directory for Claude sessions
      - ./app-data/workspace:/home/gorp/workspace

      # MCP tool data directories
      - ./app-data/mcp-data/chronicle:/home/gorp/.local/share/chronicle
      - ./app-data/mcp-data/memory:/home/gorp/.local/share/memory
      - ./app-data/mcp-data/toki:/home/gorp/.local/share/toki
      - ./app-data/mcp-data/pagen:/home/gorp/.local/share/pagen
      - ./app-data/mcp-data/gsuite-mcp:/home/gorp/.config/gsuite-mcp
      - ./app-data/mcp-data/digest:/home/gorp/.local/share/digest
      - ./app-data/mcp-data/charm:/home/gorp/.local/share/charm

    # Webhook port
    ports:
      - "13000:13000"

    # Logging configuration
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"
